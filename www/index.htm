<!DOCTYPE html>
<html>
<html lang="us">
<head>
	<meta charset="utf-8">
	<title>Arduino Beacon Controller</title>
	<script src="jquery.min.js"></script>
	<script src="jquery-ui.min.js"></script>
	<link href="jquery-ui.min.css" rel="stylesheet">
	<script>
	function GetArduinoIO()
	{
	}
	</script>
	<style>
	.undotext
	{
		margin: 0;
		padding : 0;
		height: 30px;
		width: 30px;
	}
	.settext
	{
		margin: 0;
		padding: 0;
		height: 30px;
		width: 30px;
	}
	.TextError
	{
		color: red;
	}
	</style>
</head>
<body onload="GetArduinoIO()">
<h1>Arduino Beacon Controller</h1>
<div id="tabs">
	<ul>
		<li><a href="#tabs-1">Configuration</a></li>
		<li><a href="#tabs-2">Status</a></li>
		<li><a href="#tabs-3">Logs</a></li>
	</ul>
	<div id="tabs-1">
		<div id="accordion">
			<h2 id="b0">Beacon 0 <span id="b0_titleState">Off</span></h2>
			<div>
				<table>
				<tr><td>Transmit:</td><td><input type="checkbox" name="transmit" id="b0_tx"></input><label for="b0_tx">Off</label></td></tr>
				<tr><td>Default text:</td><td><input type="text" name="text" id="b0_text" value="example text"></input></td><td><button class="undotext">Undo</button></td><td><button class="settext">Set</button></td></tr>
				<tr><td>Text h+00:</td><td><input type="text" name="t0" value="hallo"/></td><td><button class="undotext">Undo</button></td><td><button class="settext">Set</button></td></tr>
				<tr><td>Text h+15:</td><td><input type="text" name="t15"/></td><td><button class="undotext">Undo</button></td><td><button class="settext">Set</button></td></tr>
				<tr><td>Text h+30:</td><td><input type="text" name="t30"/></td><td><button class="undotext">Undo</button></td><td><button class="settext">Set</button></td></tr>
				<tr><td>Text h+45:</td><td><input type="text" name="t45"/></td><td><button class="undotext">Undo</button></td><td><button class="settext">Set</button></td></tr>
				</table>
			</div>
			<h2 id="b1">Beacon 1 <span id="b1_titleState">Off</span></h2>
			<div>
				<table>
				<tr><td>Transmit:</td><td><input type="checkbox" name="transmit" id="b1_tx"><label for="b1_tx">Off</label></td></tr>
				<tr><td>Default text:</td><td><input type="text" name="text"></input></td><td><button class="undotext">Undo</button></td><td><button class="settext">Set</button></td></tr>
				<tr><td>Text h+00:</td><td><input type="text" name="t0" /></td><td><button class="undotext">Undo</button></td><td><button class="settext">Set</button></td></tr>
				<tr><td>Text h+15:</td><td><input type="text" name="t15"/></td><td><button class="undotext">Undo</button></td><td><button class="settext">Set</button></td></tr>
				<tr><td>Text h+30:</td><td><input type="text" name="t30"/></td><td><button class="undotext">Undo</button></td><td><button class="settext">Set</button></td></tr>
				<tr><td>Text h+45:</td><td><input type="text" name="t45"/></td><td><button class="undotext">Undo</button></td><td><button class="settext">Set</button></td></tr>
				</table>
			</div>
			<h2 id="b2">Beacon 2 <span id="b2_titleState">Off</span></h2>
			<div>
				<table>
				<tr><td>Transmit:</td><td><input type="checkbox" name="transmit" id="b2_tx"><label for="b2_tx">Off</label></td></tr>
				<tr><td>Default text:</td><td><input type="text" name="text"></input></td><td><button class="undotext">Undo</button></td><td><button class="settext">Set</button></td></tr>
				<tr><td>Text h+00:</td><td><input type="text" name="t0" /></td><td><button class="undotext">Undo</button></td><td><button class="settext">Set</button></td></tr>
				<tr><td>Text h+15:</td><td><input type="text" name="t15"/></td><td><button class="undotext">Undo</button></td><td><button class="settext">Set</button></td></tr>
				<tr><td>Text h+30:</td><td><input type="text" name="t30"/></td><td><button class="undotext">Undo</button></td><td><button class="settext">Set</button></td></tr>
				<tr><td>Text h+45:</td><td><input type="text" name="t45"/></td><td><button class="undotext">Undo</button></td><td><button class="settext">Set</button></td></tr>
				</table>
			</div>
			<h2 id="b3">Beacon 3 <span id="b3_titleState">Off</span></h2>
			<div>
				<table>
				<tr><td>Transmit:</td><td><input type="checkbox" name="transmit" id="b3_tx"><label for="b3_tx">Off</label></td></tr>
				<tr><td>Default text:</td><td><input type="text" name="text"></input></td><td><button class="undotext">Undo</button></td><td><button class="settext">Set</button></td></tr>
				<tr><td>Text h+00:</td><td><input type="text" name="t0" /></td><td><button class="undotext">Undo</button></td><td><button class="settext">Set</button></td></tr>
				<tr><td>Text h+15:</td><td><input type="text" name="t15"/></td><td><button class="undotext">Undo</button></td><td><button class="settext">Set</button></td></tr>
				<tr><td>Text h+30:</td><td><input type="text" name="t30"/></td><td><button class="undotext">Undo</button></td><td><button class="settext">Set</button></td></tr>
				<tr><td>Text h+45:</td><td><input type="text" name="t45"/></td><td><button class="undotext">Undo</button></td><td><button class="settext">Set</button></td></tr>
				</table>
			</div>
			<h2 id="b4">Beacon 4 <span id="b4_titleState">Off</span></h2>
			<div>
				<table>
				<tr><td>Transmit:</td><td><input type="checkbox" name="transmit" id="b4_tx"><label for="b4_tx">Off</label></td></tr>
				<tr><td>Default text:</td><td><input type="text" name="text"></input></td><td><button class="undotext">Undo</button></td><td><button class="settext">Set</button></td></tr>
				<tr><td>Text h+00:</td><td><input type="text" name="t0" /></td><td><button class="undotext">Undo</button></td><td><button class="settext">Set</button></td></tr>
				<tr><td>Text h+15:</td><td><input type="text" name="t15"/></td><td><button class="undotext">Undo</button></td><td><button class="settext">Set</button></td></tr>
				<tr><td>Text h+30:</td><td><input type="text" name="t30"/></td><td><button class="undotext">Undo</button></td><td><button class="settext">Set</button></td></tr>
				<tr><td>Text h+45:</td><td><input type="text" name="t45"/></td><td><button class="undotext">Undo</button></td><td><button class="settext">Set</button></td></tr>
				</table>
			</div>
			<h2 id="b5">Beacon 5 <span id="b5_titleState">Off</span></h2>
			<div>
				<table>
				<tr><td>Transmit:</td><td><input type="checkbox" name="transmit" id="b5_tx"><label for="b5_tx">Off</label></td></tr>
				<tr><td>Default text:</td><td><input type="text" name="text"></input></td><td><button class="undotext">Undo</button></td><td><button class="settext">Set</button></td></tr>
				<tr><td>Text h+00:</td><td><input type="text" name="t0" /></td><td><button class="undotext">Undo</button></td><td><button class="settext">Set</button></td></tr>
				<tr><td>Text h+15:</td><td><input type="text" name="t15"/></td><td><button class="undotext">Undo</button></td><td><button class="settext">Set</button></td></tr>
				<tr><td>Text h+30:</td><td><input type="text" name="t30"/></td><td><button class="undotext">Undo</button></td><td><button class="settext">Set</button></td></tr>
				<tr><td>Text h+45:</td><td><input type="text" name="t45"/></td><td><button class="undotext">Undo</button></td><td><button class="settext">Set</button></td></tr>
				</table>
			</div>
			<h2 id="b6">Beacon 6 <span id="b6_titleState">Off</span></h2>
			<div>
				<table>
				<tr><td>Transmit:</td><td><input type="checkbox" name="transmit" id="b6_tx"><label for="b6_tx">Off</label></td></tr>
				<tr><td>Default text:</td><td><input type="text" name="text"></input></td><td><button class="undotext">Undo</button></td><td><button class="settext">Set</button></td></tr>
				<tr><td>Text h+00:</td><td><input type="text" name="t0" /></td><td><button class="undotext">Undo</button></td><td><button class="settext">Set</button></td></tr>
				<tr><td>Text h+15:</td><td><input type="text" name="t15"/></td><td><button class="undotext">Undo</button></td><td><button class="settext">Set</button></td></tr>
				<tr><td>Text h+30:</td><td><input type="text" name="t30"/></td><td><button class="undotext">Undo</button></td><td><button class="settext">Set</button></td></tr>
				<tr><td>Text h+45:</td><td><input type="text" name="t45"/></td><td><button class="undotext">Undo</button></td><td><button class="settext">Set</button></td></tr>
				</table>
			</div>
			<h2 id="b7">Beacon 7 <span id="b7_titleState">Off</span></h2>
			<div>
				<table>
				<tr><td>Transmit:</td><td><input type="checkbox" name="transmit" id="b7_tx"><label for="b7_tx">Off</label></td></tr>
				<tr><td>Default text:</td><td><input type="text" name="text"></input></td><td><button class="undotext">Undo</button></td><td><button class="settext">Set</button></td></tr>
				<tr><td>Text h+00:</td><td><input type="text" name="t0" /></td><td><button class="undotext">Undo</button></td><td><button class="settext">Set</button></td></tr>
				<tr><td>Text h+15:</td><td><input type="text" name="t15"/></td><td><button class="undotext">Undo</button></td><td><button class="settext">Set</button></td></tr>
				<tr><td>Text h+30:</td><td><input type="text" name="t30"/></td><td><button class="undotext">Undo</button></td><td><button class="settext">Set</button></td></tr>
				<tr><td>Text h+45:</td><td><input type="text" name="t45"/></td><td><button class="undotext">Undo</button></td><td><button class="settext">Set</button></td></tr>
				</table>
			</div>
			<h2 id="b8">Beacon 8 <span id="b8_titleState">Off</span></h2>
			<div>
				<table>
				<tr><td>Transmit:</td><td><input type="checkbox" name="transmit" id="b8_tx"><label for="b8_tx">Off</label></td></tr>
				<tr><td>Default text:</td><td><input type="text" name="text"></input></td><td><button class="undotext">Undo</button></td><td><button class="settext">Set</button></td></tr>
				<tr><td>Text h+00:</td><td><input type="text" name="t0" /></td><td><button class="undotext">Undo</button></td><td><button class="settext">Set</button></td></tr>
				<tr><td>Text h+15:</td><td><input type="text" name="t15"/></td><td><button class="undotext">Undo</button></td><td><button class="settext">Set</button></td></tr>
				<tr><td>Text h+30:</td><td><input type="text" name="t30"/></td><td><button class="undotext">Undo</button></td><td><button class="settext">Set</button></td></tr>
				<tr><td>Text h+45:</td><td><input type="text" name="t45"/></td><td><button class="undotext">Undo</button></td><td><button class="settext">Set</button></td></tr>
				</table>
			</div>
			<h2 id="b9">Beacon 9 <span id="b9_titleState">Off</span></h2>
			<div>
				<table>
				<tr><td>Transmit:</td><td><input type="checkbox" name="transmit" id="b9_tx"><label for="b9_tx">Off</label></td></tr>
				<tr><td>Default text:</td><td><input type="text" name="text"></input></td><td><button class="undotext">Undo</button></td><td><button class="settext">Set</button></td></tr>
				<tr><td>Text h+00:</td><td><input type="text" name="t0" /></td><td><button class="undotext">Undo</button></td><td><button class="settext">Set</button></td></tr>
				<tr><td>Text h+15:</td><td><input type="text" name="t15"/></td><td><button class="undotext">Undo</button></td><td><button class="settext">Set</button></td></tr>
				<tr><td>Text h+30:</td><td><input type="text" name="t30"/></td><td><button class="undotext">Undo</button></td><td><button class="settext">Set</button></td></tr>
				<tr><td>Text h+45:</td><td><input type="text" name="t45"/></td><td><button class="undotext">Undo</button></td><td><button class="settext">Set</button></td></tr>
				</table>
			</div>
		</div>
	</div>

	<div id="tabs-2">
	</div>

	<div id="tabs-3">
	</div>
</div>
<button id="debugbutton">A debug button</button>

<script>
function checkMorseString(str)
{
	for(var i=0; i<str.length; i++)
	{
		if((str[i]>='0') && (str[i]<='9'))
			continue;
		if((str[i]>='a') && (str[i]<='z'))
			continue;
		if((str[i]>='A') && (str[i]<='Z'))
			continue;
		switch(str[i])
		{
		case '=':
		case '?':
		case '/':
		case '.':
		case ',':
		case ' ':
			continue;
		}
		if(str[i]=='$')
		{
			i++;
			if(i==str.length)
				return false;
			if((str[i]=='P') || (str[i]=='p'))
			{
				i++;
				if(i==str.length)
					return false; // Error: string ends with "$P"

				if((str[i]>='0') && (str[i]<='3'))
					continue;
				else
					return false; // Error: Power mode not 0-3
			}
			else if((str[i]=='A') || (str[i]=='a'))
			{
				var channel = 0;
				i++;
				if(i==str.length)
					return false; // Error: string ends with "$A"

				if((str[i]>='0') && (str[i]<='9'))
					channel = str[i];
				else
					return false; // Error: not a digit
				i++;
				if(i==str.length)
					return false; // Error: string ends with "$An" (n:0-9)

				if((str[i]>='0') && (str[i]<='9'))
					channel = channel + str[i];  
				else
					return false; // Error: not a digit
				channel = parseInt(channel,10);
				if(channel <= 15)
					continue;
				else
					return false; // Error: channel is not in range (00-15)
			}
			else if((str[i]=='T') || (str[i]=='t'))
			{
				i++;
				if(i==str.length)
					return false; // Error: string ends with "$T"

				if((str[i]>='0') && (str[i]<='7'))
					continue;
				else
					return false; // Error: Temperature sensor not 0-7
			}
			else if(str[i]=='+')
			{
				i++;
				if(i==str.length)
					return false; // Error: string ends with "$+"

				if((str[i]>='1') && (str[i]<='9'))
					continue;
				else
					return false; // Error: Delay not 1-9
			}
			else if(str[i]=='-')
			{
				i++;
				if(i==str.length)
					return false; // Error: string ends with "$-"

				if((str[i]>='1') && (str[i]<='9'))
					continue;
				else
					return false; // Error: Delay not 1-9
			}
		}
		return false;
	}
	return true;
}

$("#tabs").tabs();
$("#accordion").accordion();
$("[name=transmit]").button();
$("[name=transmit]").prop("checked", false);
$("[name=transmit]").click(
	function()
	{
		var text = this.checked ? "On" : "Off";
		$(this).button("option", "label", text);
		var header = $(this).parentsUntil("#accordion").last().prev();
		header.children("span").text(text); // Show On/off state in the accorion header
		var beaconid = header.attr("id");
		console.log("beacon: " + beaconid +  "    state: " + text);
	});

$("#debugbutton").button();
$("#debugbutton").click(
	function()
	{
		$("[name=transmit]").each(
			function(index)
			{
				var text = this.checked ? "On" : "Off";
				console.log("Beacon " + index + ": " + text);
			});
		
	});
// Make the button height the same as a text input field. I get the height of the first text input (they should all be the same)
$(".undotext").button({icons: {primary:"ui-icon-arrowreturnthick-1-w"},
                         text:false})
              .button("disable");

$(".settext").button({icons: {primary:"ui-icon-check"},
                      text:false})
             .button("disable");

$(".undotext").click(
function()
{
	var textfield = $(this).parentsUntil("tbody").last().find("input");
	$(textfield).val($(textfield).attr("value"));

	$(this).button("disable");
	getSetTextButton($(this)).button("disable");
});

$(".settext").click(
function()
{
	var textfield = $(this).parentsUntil("tbody").last().find("input");
	var text = $(textfield).val();
	if(checkMorseString(text))
	{
		$(textfield).attr("value", text);
	}

	getUndoButton($(this)).button("disable");
	$(this).button("disable");
	var beaconid = getTextBeaconID($(this));
	var textid = $(textfield).attr("name");
	console.log("beacon: " + beaconid + "    textid: " + textid + "    text: " + text);
});

function getSetTextButton(input)
{
	var retval = input.parentsUntil("tbody").last().find(".settext");
	return retval;
}
function getUndoButton(input)
{
	var retval = input.parentsUntil("tbody").last().find(".undotext");
	return retval;
}
function getTextBeaconID(input)
{
	var retval = input.parentsUntil("#accordion").last().prev().attr("id");
	return retval;
}

$("[type=text]").on("input propertychange paste",
	function()
	{
		var modified = (this.value != $(this).attr("value"));
		if(modified)
		{
			getUndoButton($(this)).button("enable");
		}
		else
		{
			getUndoButton($(this)).button("disable");
		}

		if(checkMorseString(this.value))
		{
			$(this).removeClass("TextError");
			if(modified)
			{
				getSetTextButton($(this)).button("enable");
			}
			else
			{
				getSetTextButton($(this)).button("disable");
			}
		}
		else
		{
			$(this).addClass("TextError");
			getSetTextButton($(this)).button("disable");
		}
	});
</script>

</body>
</html>
